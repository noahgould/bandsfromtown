<!DOCTYPE html>
<style>
    div {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
    }
    #mapid {height: 600px;}
</style>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
</head>
<html>
<body>

    <button onclick="getArtists()" type="button">
        Where are my artists from?</button>

<div id="mapid"></div>
<div id="unknownLocations" style="display:none">
    <h1>We were unable to find a location for the following artists. Perhaps you could add it?</h1>
</div>
<script>

    var map, marker;

    function getArtists() {
        var accessToken = "{{.}}"

        let request = new XMLHttpRequest();
        let url = "http://localhost:8080/spotify/locations/" + accessToken;
        request.open("GET", url);
        request.setRequestHeader("Content-type", "application/json");
        request.send();
        request.onload = function () {
            var response = JSON.parse(request.responseText);

            response.forEach(function(artist) {
                if (artist.location.google_place_id === "-1") {
                    addUnknownLocation(artist)
                } else {
                    addLocationToMap(artist)
                }
            })
        }

    }


    function addLocationToMap(artist) {
        if(typeof map !== "undefined") {
                map.panTo([artist.location.latitude, artist.location.longitude])
                marker = new L.marker([artist.location.latitude, artist.location.longitude]).addTo(map);
                marker.bindPopup("<b>" + artist.name +"</b><br>"+artist.location.location_string);
            } else {
                map = L.map('mapid').setView([artist.location.latitude, artist.location.longitude], 5);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map)

                marker = L.marker([artist.location.latitude, artist.location.longitude]).addTo(map);
                marker.bindPopup("<b>" + artist.name +"</b><br>"+artist.location.location_string);
            }
    }

    function addUnknownLocation(artist) {
        unknownDiv = document.getElementById("unknownLocations")
        if (unknownDiv.display == "none") { unknownDiv.display = "block"};
        unknownDiv.appendChild(document.createElement("br"));
        newArtist = document.createTextNode(artist.name)
        unknownDiv.appendChild(newArtist);
    }


</script>

</body>
</html>
