<!DOCTYPE html>
<style>
    div {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
    }
    #mapid {height: 300px;}
</style>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
</head>
<html>
<body>
<div style="display:inline-block">
    <h1>Where is</h1>
</div>
<div style="display:inline-block">
        <input type="text" id="artistInput" name="artistname" style="font-size: 24pt" >
</div>
<div style="display:inline-block">
        <h1>From?</h1>
</div>

<div>
    <h1 id="full-location"></h1>
    <h1 id="city"></h1>
    <h1 id="state"></h1>
    <h1 id="country"></h1>
</div>
<div id="mapid"></div>
<div>
    <p1> Location wrong?</p1>
    <button type="button" id="updateLocation" onclick="showLocationUpdate()">Update it.</button>
</div>
<div id=artistUpdate style="display:none;">
    <input type="text" id="newCity">
    <input type="text" id="newState">
    <input type="text" id="newCountry">
    <button type="button" id="enterLocation" onclick="updateLocation()">Update</button>
</div>
<script>
    document.getElementById("artistInput")
        .addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13 ) {
                lookupArtist()
            }
        });
    

    function showLocationUpdate() {
        document.getElementById("artistUpdate")
            .style.display = "block"
    }

    function updateLocation() {
        var city = document.getElementById("newCity").value;
        var state = document.getElementById("newState").value;
        var country = document.getElementById("newCountry").value;
        if (city == "" || state == "" || country == "") {
            document.getElementById("full-location").innerHTML = "One location element is missing."
        } else {
            var locationString = city + "," + state + "," + country;
            let request = new XMLHttpRequest();
            let url = "https://bandsfromtown.herokuapp.comartist/updateLocation"
            request.open("POST", url);
            request.setRequestHeader("Content-type", "application/json")
            request.send("artistID=" + document.getElementById("updateLocation").value + "location=" + locationString)
        }
    }

    var map, marker;
    function lookupArtist() {
        var artistName = document.getElementById("artistInput").value;
        let request = new XMLHttpRequest();
        let url = "https://bandsfromtown.herokuapp.com/artist/" + artistName;
        request.open("GET", url);
        request.setRequestHeader("Content-type", "application/json");
        request.send();
        request.onload = function () {
            
            var response = JSON.parse(request.responseText);
            console.log(response); 
            var resultP = document.getElementById("results")

            document.getElementById("full-location").innerHTML = response[0].location.location_string
            document.getElementById("updateLocation").value = response[0].ID
            
            if(typeof map !== "undefined") {
                //map.removeLayer(marker);
                map.panTo([response[0].location.latitude, response[0].location.longitude])
                marker = new L.marker([response[0].location.latitude, response[0].location.longitude]).addTo(map);
                marker.bindPopup("<b>" + response[0].name +"</b><br>"+response[0].location.location_string)
            } else {
                map = L.map('mapid').setView([response[0].location.latitude, response[0].location.longitude], 5);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map)

                marker = L.marker([response[0].location.latitude, response[0].location.longitude]).addTo(map);

            }

        }
        }
    

</script>

</body>
</html>
